"use strict";var t=require("axios"),e=require("https"),i=require("zod");function r(t){var e=Object.create(null);return t&&Object.keys(t).forEach((function(i){if("default"!==i){var r=Object.getOwnPropertyDescriptor(t,i);Object.defineProperty(e,i,r.get?r:{enumerable:!0,get:function(){return t[i]}})}})),e.default=t,Object.freeze(e)}var s,o=r(e);function a(t,e){if(!t.baseUrl)throw new Error(`${e} service baseUrl is required`);try{new URL(t.baseUrl)}catch(t){throw new Error(`${e} service baseUrl must be a valid URL`)}if(void 0!==t.timeout&&(t.timeout<0||t.timeout>3e5))throw new Error(`${e} service timeout must be between 0 and 300000ms`);if(void 0!==t.retries&&(t.retries<0||t.retries>10))throw new Error(`${e} service retries must be between 0 and 10`)}function n(t){var e;if(!t.auth)throw new Error("Auth service configuration is required");if(!t.registry)throw new Error("Registry service configuration is required");if(!t.node)throw new Error("Node service configuration is required");if(t.certificate&&(!t.certificate.cert||!t.certificate.key))throw new Error("Certificate must include both cert and key when provided");if(a(t.auth,"auth"),a(t.registry,"registry"),a(t.node,"node"),t.tokenStorage&&!["localStorage","sessionStorage","memory"].includes(t.tokenStorage))throw new Error("tokenStorage must be one of: localStorage, sessionStorage, memory");if(null===(e=t.errorHandling)||void 0===e?void 0:e.autoRetryNetwork){const{maxRetries:e,delay:i,backoff:r}=t.errorHandling.autoRetryNetwork;if(e<0||e>10)throw new Error("autoRetryNetwork.maxRetries must be between 0 and 10");if(void 0!==i&&(i<0||i>6e4))throw new Error("autoRetryNetwork.delay must be between 0 and 60000ms");if(r&&!["linear","exponential"].includes(r))throw new Error("autoRetryNetwork.backoff must be either linear or exponential")}}function u(t,e,i,r){return new(i||(i=Promise))((function(s,o){function a(t){try{u(r.next(t))}catch(t){o(t)}}function n(t){try{u(r.throw(t))}catch(t){o(t)}}function u(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,n)}u((r=r.apply(t,e||[])).next())}))}exports.Predicate=void 0,(s=exports.Predicate||(exports.Predicate={})).IS_PARENT_OF="IS_PARENT_OF",s.IS_CHILD_OF="IS_CHILD_OF",s.IS_INPUT_OF="IS_INPUT_OF",s.IS_OUTPUT_OF="IS_OUTPUT_OF",s.IS_SOURCE_TEMPLATE_OF="IS_SOURCE_TEMPLATE_OF",s.IS_TEMPLATE_INSTANCE_OF="IS_TEMPLATE_INSTANCE_OF",s.IS_PROPERTY_OF="IS_PROPERTY_OF",s.HAS_PROPERTY="HAS_PROPERTY",s.IS_VALUE_OF="IS_VALUE_OF",s.HAS_VALUE="HAS_VALUE",s.IS_FILE_OF="IS_FILE_OF",s.HAS_FILE="HAS_FILE",s.HAS_ADDRESS="HAS_ADDRESS",s.IS_ADDRESS_OF="IS_ADDRESS_OF","function"==typeof SuppressedError&&SuppressedError;let d={enabled:!1,logLevel:"error",logToConsole:!0,logCallback:null};const c=(t,e)=>{d.enabled&&((t,e,i)=>{if(!d.enabled)return;d.logLevel;const r=`[IoM Client] ${e}`;d.logToConsole&&console.error(r,i||""),d.logCallback&&d.logCallback(r,i)})(0,`Error in ${t}`,e)};class l{constructor(e,i,r){const s={baseURL:e.baseUrl,timeout:e.timeout||3e4};r&&(s.httpsAgent=new o.Agent({cert:r.cert,key:r.key,rejectUnauthorized:!0})),this.axiosInstance=t.create(s)}login(){return u(this,void 0,void 0,(function*(){const t=yield this.axiosInstance.get("/api/auth/login"),{accessToken:e,user:i}=t.data,r=e.trim(),s=function(t){let e=3600;try{const i=t.split(".");if(3===i.length){const t=i[1].replace(/-/g,"+").replace(/_/g,"/"),r=t+"=".repeat((4-t.length%4)%4),s="undefined"!=typeof atob?atob(r):Buffer.from(r,"base64").toString("utf-8"),o=JSON.parse(s);o.exp&&o.iat&&(e=o.exp-o.iat)}}catch(t){c("Failed to decode JWT payload for expiry calculation",t)}return e}(r);return{token:r,expiresIn:s,tokenType:"Bearer",user:i}}))}}class h{constructor(t,e,i){this.axios=i}getOwnedUUIDs(){return u(this,void 0,void 0,(function*(){return(yield this.axios.get("/api/UUID")).data}))}createUUID(){return u(this,void 0,void 0,(function*(){return(yield this.axios.post("/api/UUID")).data}))}getUUIDRecord(t){return u(this,void 0,void 0,(function*(){return(yield this.axios.get(`/api/UUID/${t}`)).data}))}updateUUIDRecordMeta(t,e){return u(this,void 0,void 0,(function*(){return(yield this.axios.put(`/api/UUID/${t}/meta`,e)).data}))}authorizeUUIDRecord(t){return u(this,void 0,void 0,(function*(){return(yield this.axios.post(`/api/UUID/${t.uuid}/authorize`,{targetUserUUID:t.targetUserUUID,permissions:t.permissions})).data}))}}class p{constructor(t,e,i,r){this.errorHandling=e,this.axios=i,this.registryClient=r}getAxios(){return this.axios}request(t){return u(this,void 0,void 0,(function*(){const e=yield this.axios.request(t);return{data:e.data,status:e.status,statusText:e.statusText,headers:e.headers}}))}getObjects(t){return u(this,void 0,void 0,(function*(){return(yield this.axios.get("/api/UUObject",{params:t})).data}))}createOrUpdateObject(t){return u(this,void 0,void 0,(function*(){return(yield this.axios.post("/api/UUObject",t)).data}))}createObject(t){return u(this,void 0,void 0,(function*(){return(yield this.axios.post("/api/UUObject",t)).data}))}updateObject(t){return u(this,void 0,void 0,(function*(){return(yield this.axios.put(`/api/UUObject/${t.uuid}`,t)).data}))}softDeleteObject(t){return u(this,void 0,void 0,(function*(){return(yield this.axios.delete(`/api/UUObject/${t}`)).data}))}getProperties(t){return u(this,void 0,void 0,(function*(){return(yield this.axios.get("/api/UUProperty",{params:t})).data}))}createOrUpdateProperty(t){return u(this,void 0,void 0,(function*(){return(yield this.axios.post("/api/UUProperty",t)).data}))}createProperty(t){return u(this,void 0,void 0,(function*(){return(yield this.axios.post("/api/UUProperty",t)).data}))}softDeleteProperty(t){return u(this,void 0,void 0,(function*(){return(yield this.axios.delete(`/api/UUProperty/${t}`)).data}))}getPropertyValues(t){return u(this,void 0,void 0,(function*(){return(yield this.axios.get("/api/UUPropertyValue",{params:t})).data}))}createOrUpdatePropertyValue(t){return u(this,void 0,void 0,(function*(){return(yield this.axios.post("/api/UUPropertyValue",t)).data}))}createPropertyValue(t){return u(this,void 0,void 0,(function*(){return(yield this.axios.post("/api/UUPropertyValue",t)).data}))}softDeletePropertyValue(t){return u(this,void 0,void 0,(function*(){return(yield this.axios.delete(`/api/UUPropertyValue/${t}`)).data}))}getStatements(t){return u(this,void 0,void 0,(function*(){return(yield this.axios.get("/api/UUStatements",{params:t})).data}))}createStatement(t){return u(this,void 0,void 0,(function*(){return(yield this.axios.post("/api/UUStatements",t)).data}))}softDeleteStatement(t,e,i){return u(this,void 0,void 0,(function*(){return(yield this.axios.delete("/api/UUStatements",{data:{subject:t,predicate:e,object:i}})).data}))}getFiles(t){return u(this,void 0,void 0,(function*(){return(yield this.axios.get("/api/UUFile",{params:t})).data}))}uploadFile(t,e){return u(this,void 0,void 0,(function*(){const i=new FormData;i.append("file",t),e&&Object.entries(e).forEach((([t,e])=>{void 0!==e&&i.append(t,String(e))}));return(yield this.axios.post("/api/UUFile",i,{headers:{"Content-Type":"multipart/form-data"}})).data}))}getFile(t){return u(this,void 0,void 0,(function*(){return(yield this.axios.get(`/api/UUFile/${t}`)).data}))}downloadFile(t){return u(this,void 0,void 0,(function*(){return(yield this.axios.get(`/api/UUFile/${t}/download`,{responseType:"arraybuffer"})).data}))}softDeleteFile(t){return u(this,void 0,void 0,(function*(){return(yield this.axios.delete(`/api/UUFile/${t}`)).data}))}getAddresses(t){return u(this,void 0,void 0,(function*(){return(yield this.axios.get("/api/UUAddress",{params:t})).data}))}createOrUpdateAddress(t){return u(this,void 0,void 0,(function*(){return(yield this.axios.post("/api/UUAddress",t)).data}))}createAddress(t){return u(this,void 0,void 0,(function*(){return(yield this.axios.post("/api/UUAddress",t)).data}))}softDeleteAddress(t){return u(this,void 0,void 0,(function*(){return(yield this.axios.delete(`/api/UUAddress/${t}`)).data}))}searchAggregates(t){return u(this,void 0,void 0,(function*(){return(yield this.axios.post("/api/Aggregate/search",t)).data}))}createAggregates(t){return u(this,void 0,void 0,(function*(){return(yield this.axios.post("/api/Aggregate",t)).data}))}importAggregates(t){return u(this,void 0,void 0,(function*(){const e=yield this.axios.post("/api/Aggregate/Import",t);return{data:void 0,status:e.status,statusText:e.statusText,headers:e.headers}}))}uploadFileByReference(t){return u(this,void 0,void 0,(function*(){if(!this.registryClient)throw new Error("Registry client not available for UUID operations");try{const e=(yield this.registryClient.createUUID()).uuid,i={fileReference:t.fileReference,fileName:t.fileName,label:t.label,contentType:t.contentType,size:t.size},r=yield this.createObject(Object.assign(Object.assign({},i),{uuid:e}));return yield this.createStatement({subject:t.uuidToAttach,predicate:exports.Predicate.HAS_FILE,object:e}),{data:r,status:200,statusText:"OK"}}catch(t){return{data:null,status:t.status||500,statusText:t.message||"Error uploading file by reference"}}}))}uploadFileDirect(t){return u(this,void 0,void 0,(function*(){if(!this.registryClient)throw new Error("Registry client not available for UUID operations");try{const e=(yield this.registryClient.createUUID()).uuid,i=yield this.uploadFile(t.file,{uuid:e,label:t.label});return yield this.createStatement({subject:t.uuidToAttach,predicate:exports.Predicate.HAS_FILE,object:e}),{data:i,status:200,statusText:"OK"}}catch(t){return{data:null,status:t.status||500,statusText:t.message||"Error uploading file binary"}}}))}addPropertyToObject(t,e){return u(this,void 0,void 0,(function*(){if(!this.registryClient)throw new Error("Registry client not available");const r=i.z.string().uuid().parse(t);let s;if(e.uuid)s=e;else{const{uuid:t}=yield this.registryClient.createUUID();s=Object.assign(Object.assign({},e),{uuid:t})}const o=yield this.createProperty(s);return yield this.createStatement({subject:r,predicate:exports.Predicate.HAS_PROPERTY,object:o.uuid}),yield this.createStatement({subject:o.uuid,predicate:exports.Predicate.IS_PROPERTY_OF,object:r}),{data:o,status:200,statusText:"OK"}}))}getPropertiesForObject(t,e){return u(this,void 0,void 0,(function*(){const i=yield this.getStatements(Object.assign({subject:t,predicate:exports.Predicate.HAS_PROPERTY},e));if(!i.length)return{data:[],status:200,statusText:"OK"};const r=[];for(const t of i)try{const i=yield this.getProperties(Object.assign({uuid:t.object},e));i[0]&&r.push(i[0])}catch(t){}return{data:r,status:200,statusText:"OK"}}))}setValueForProperty(t,e){return u(this,void 0,void 0,(function*(){if(!this.registryClient)throw new Error("Registry client not available");const r=i.z.string().uuid().parse(t);let s;if(e.uuid)s=e;else{const{uuid:t}=yield this.registryClient.createUUID();s=Object.assign(Object.assign({},e),{uuid:t})}const o=yield this.createPropertyValue(s);return yield this.createStatement({subject:r,predicate:exports.Predicate.HAS_VALUE,object:o.uuid}),yield this.createStatement({subject:o.uuid,predicate:exports.Predicate.IS_VALUE_OF,object:r}),{data:o,status:200,statusText:"OK"}}))}getValuesForProperty(t,e){return u(this,void 0,void 0,(function*(){try{const r=i.z.string().uuid().parse(t),s=yield this.getStatements(Object.assign({subject:r,predicate:exports.Predicate.HAS_VALUE},e));if(!s||0===s.length)return{data:[],status:200,statusText:"OK"};const o=[];for(const t of s)try{const i=(yield this.getPropertyValues(Object.assign({uuid:t.object},e))).find((e=>e.uuid===t.object));i&&o.push(i)}catch(t){}return{data:o,status:200,statusText:"OK"}}catch(t){return{data:[],status:t.status||500,statusText:t.message||"Error getting values for property"}}}))}updateErrorHandling(t){this.errorHandling=t}}class f{constructor(t){this.token=null,this.user=null,this.listeners=new Set,this.STORAGE_KEY="iom-auth-state",n(t),this.config=t,this.loadState(),this.auth=new l(t.auth,t.errorHandling||{},t.certificate),this.registry=new h(t.registry,t.errorHandling||{},this.createServiceAxiosInstance(t.registry.baseUrl)),this.node=new p(t.node,t.errorHandling||{},this.createServiceAxiosInstance(t.node.baseUrl)),this.axiosInstance=this.node.getAxios()}createServiceAxiosInstance(e){const i=t.create({baseURL:e,timeout:3e4});return i.interceptors.request.use((t=>(this.token&&(t.headers.Authorization=`Bearer ${this.token}`),t))),i.interceptors.response.use((t=>t),(t=>{var e;return 401===(null===(e=t.response)||void 0===e?void 0:e.status)&&this.logout(),Promise.reject(t)})),"undefined"==typeof window&&this.config.certificate&&(i.defaults.httpsAgent=new o.Agent({cert:this.config.certificate.cert,key:this.config.certificate.key,rejectUnauthorized:!0})),i}loadState(){if("undefined"!=typeof window&&window.localStorage){const t=localStorage.getItem(this.STORAGE_KEY);if(t)try{const{token:e,user:i}=JSON.parse(t);this.token=e,this.user=i}catch(t){localStorage.removeItem(this.STORAGE_KEY)}}}saveState(){"undefined"!=typeof window&&window.localStorage&&(this.token?localStorage.setItem(this.STORAGE_KEY,JSON.stringify({token:this.token,user:this.user})):localStorage.removeItem(this.STORAGE_KEY)),this.notifyListeners()}notifyListeners(){const t={isAuthenticated:this.isAuthenticated(),user:this.user};this.listeners.forEach((e=>e(t)))}onAuthStateChange(t){return this.listeners.add(t),t({isAuthenticated:this.isAuthenticated(),user:this.user}),()=>this.listeners.delete(t)}login(){return u(this,void 0,void 0,(function*(){try{const t=yield this.auth.login();return this.token=t.token,this.user=t.user||null,this.saveState(),{success:!0,user:this.user||void 0}}catch(t){return this.logout(),{success:!1}}}))}logout(){this.token=null,this.user=null,this.saveState()}isAuthenticated(){if(!this.token)return!1;try{const t=JSON.parse(atob(this.token.split(".")[1]));return!(t.exp&&Date.now()>=1e3*t.exp)||(this.logout(),!1)}catch(t){return!1}}getUser(){return this.user}getToken(){return this.isAuthenticated()?this.token:null}getAxios(){return this.axiosInstance}}function g(t){return new f(t)}const y=g;exports.AuthServiceClient=l,exports.Client=f,exports.NodeServiceClient=p,exports.RegistryServiceClient=h,exports.configureLogger=t=>{var e,i,r;t&&(d={enabled:null!==(e=t.enabled)&&void 0!==e?e:d.enabled,logLevel:"info"===t.logLevel?"info":"error",logToConsole:null!==(i=t.logToConsole)&&void 0!==i?i:d.logToConsole,logCallback:null!==(r=t.logCallback)&&void 0!==r?r:d.logCallback})},exports.createClient=y,exports.createDefaultErrorHandling=function(){return{debug:!1,autoRetryAuth:!0,autoRetryNetwork:{maxRetries:3,delay:1e3,backoff:"exponential"}}},exports.createDefaultServiceConfig=function(t){return{baseUrl:t,timeout:3e4,retries:3,headers:{}}},exports.initClient=g,exports.validateSDKConfig=n,exports.validateServiceConfig=a;
//# sourceMappingURL=index.js.map
