"use strict";var e=require("https"),t=require("axios"),r=require("zod");function i(e){var t=Object.create(null);return e&&Object.keys(e).forEach((function(r){if("default"!==r){var i=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,i.get?i:{enumerable:!0,get:function(){return e[r]}})}})),t.default=e,Object.freeze(t)}var s,o=i(e);function n(e,t){if(!e.baseUrl)throw new Error(`${t} service baseUrl is required`);try{new URL(e.baseUrl)}catch(e){throw new Error(`${t} service baseUrl must be a valid URL`)}if(void 0!==e.timeout&&(e.timeout<0||e.timeout>3e5))throw new Error(`${t} service timeout must be between 0 and 300000ms`);if(void 0!==e.retries&&(e.retries<0||e.retries>10))throw new Error(`${t} service retries must be between 0 and 10`)}function a(e){var t;if(!e.auth)throw new Error("Auth service configuration is required");if(!e.registry)throw new Error("Registry service configuration is required");if(!e.node)throw new Error("Node service configuration is required");if(e.certificate&&(!e.certificate.cert||!e.certificate.key))throw new Error("Certificate must include both cert and key when provided");if(n(e.auth,"auth"),n(e.registry,"registry"),n(e.node,"node"),e.tokenStorage&&!["localStorage","sessionStorage","memory"].includes(e.tokenStorage))throw new Error("tokenStorage must be one of: localStorage, sessionStorage, memory");if(null===(t=e.errorHandling)||void 0===t?void 0:t.autoRetryNetwork){const{maxRetries:t,delay:r,backoff:i}=e.errorHandling.autoRetryNetwork;if(t<0||t>10)throw new Error("autoRetryNetwork.maxRetries must be between 0 and 10");if(void 0!==r&&(r<0||r>6e4))throw new Error("autoRetryNetwork.delay must be between 0 and 60000ms");if(i&&!["linear","exponential"].includes(i))throw new Error("autoRetryNetwork.backoff must be either linear or exponential")}}function u(e,t,r,i){return new(r||(r=Promise))((function(s,o){function n(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(n,a)}u((i=i.apply(e,t||[])).next())}))}exports.Predicate=void 0,(s=exports.Predicate||(exports.Predicate={})).IS_PARENT_OF="IS_PARENT_OF",s.IS_CHILD_OF="IS_CHILD_OF",s.IS_INPUT_OF="IS_INPUT_OF",s.IS_OUTPUT_OF="IS_OUTPUT_OF",s.IS_SOURCE_TEMPLATE_OF="IS_SOURCE_TEMPLATE_OF",s.IS_TEMPLATE_INSTANCE_OF="IS_TEMPLATE_INSTANCE_OF",s.IS_PROPERTY_OF="IS_PROPERTY_OF",s.HAS_PROPERTY="HAS_PROPERTY",s.IS_VALUE_OF="IS_VALUE_OF",s.HAS_VALUE="HAS_VALUE",s.IS_FILE_OF="IS_FILE_OF",s.HAS_FILE="HAS_FILE",s.HAS_ADDRESS="HAS_ADDRESS",s.IS_ADDRESS_OF="IS_ADDRESS_OF","function"==typeof SuppressedError&&SuppressedError;let d={enabled:!1,logLevel:"error",logToConsole:!0,logCallback:null};const c=(e,t,r)=>{if(!d.enabled)return;if("error"===d.logLevel&&"error"!==e)return;const i=`[IoM Client] ${t}`;d.logToConsole&&("error"===e?console.error(i,r||""):console.log(i,r||"")),d.logCallback&&d.logCallback(i,r)},l=(e,t)=>{d.enabled&&c("info",e,t)},h=(e,t)=>{d.enabled&&c("error",`Error in ${e}`,t)};class f{constructor(e,r,i){const s={baseURL:e.baseUrl,timeout:e.timeout||3e4};i&&(s.httpsAgent=new o.Agent({cert:i.cert,key:i.key,rejectUnauthorized:!0})),this.axiosInstance=t.create(s);const n={baseURL:e.refreshBaseUrl||e.baseUrl,timeout:e.timeout||3e4};this.refreshAxiosInstance=t.create(n)}login(){return u(this,void 0,void 0,(function*(){const e=yield this.axiosInstance.get("/api/auth/login"),{accessToken:t,refreshToken:r,user:i}=e.data,s=t.trim(),o=function(e){let t=3600;try{const r=e.split(".");if(3===r.length){const e=r[1].replace(/-/g,"+").replace(/_/g,"/"),i=e+"=".repeat((4-e.length%4)%4),s="undefined"!=typeof atob?atob(i):Buffer.from(i,"base64").toString("utf-8"),o=JSON.parse(s);o.exp&&o.iat&&(t=o.exp-o.iat)}}catch(e){h("Failed to decode JWT payload for expiry calculation",e)}return t}(s);return{token:s,expiresIn:o,tokenType:"Bearer",refreshToken:r,user:i}}))}refreshToken(e){return u(this,void 0,void 0,(function*(){const t={refreshToken:e};return(yield this.refreshAxiosInstance.post("/api/auth/refreshToken",t)).data}))}}class p{constructor(e,t,r){this.axios=r}getOwnedUUIDs(){return u(this,void 0,void 0,(function*(){return(yield this.axios.get("/api/UUID/own")).data}))}createUUID(){return u(this,void 0,void 0,(function*(){return(yield this.axios.post("/api/UUID")).data}))}getUUIDRecord(e){return u(this,void 0,void 0,(function*(){return(yield this.axios.get(`/api/UUID/${e}`)).data}))}updateUUIDRecordMeta(e,t){return u(this,void 0,void 0,(function*(){return(yield this.axios.put("/api/UUID/UUIDRecordMeta",t)).data}))}authorizeUUIDRecord(e){return u(this,void 0,void 0,(function*(){return(yield this.axios.post("/api/UUID/authorize",{userUUID:e.userUUID,resourceId:e.resourceId})).data}))}}class g{constructor(e,t,r,i){this.errorHandling=t,this.axios=r,this.registryClient=i}getAxios(){return this.axios}request(e){return u(this,void 0,void 0,(function*(){const t=yield this.axios.request(e);return{data:t.data,status:t.status,statusText:t.statusText,headers:t.headers}}))}getObjects(e){return u(this,void 0,void 0,(function*(){return(yield this.axios.get("/api/UUObject",{params:e})).data}))}createOrUpdateObject(e){return u(this,void 0,void 0,(function*(){return(yield this.axios.post("/api/UUObject",e)).data}))}softDeleteObject(e){return u(this,void 0,void 0,(function*(){return(yield this.axios.delete(`/api/UUObject/${e}`)).data}))}getProperties(e){return u(this,void 0,void 0,(function*(){return(yield this.axios.get("/api/UUProperty",{params:e})).data}))}createOrUpdateProperty(e){return u(this,void 0,void 0,(function*(){return(yield this.axios.post("/api/UUProperty",e)).data}))}createProperty(e){return u(this,void 0,void 0,(function*(){return(yield this.axios.post("/api/UUProperty",e)).data}))}softDeleteProperty(e){return u(this,void 0,void 0,(function*(){return(yield this.axios.delete(`/api/UUProperty/${e}`)).data}))}getPropertyValues(e){return u(this,void 0,void 0,(function*(){return(yield this.axios.get("/api/UUPropertyValue",{params:e})).data}))}createOrUpdatePropertyValue(e){return u(this,void 0,void 0,(function*(){return(yield this.axios.post("/api/UUPropertyValue",e)).data}))}createPropertyValue(e){return u(this,void 0,void 0,(function*(){return(yield this.axios.post("/api/UUPropertyValue",e)).data}))}softDeletePropertyValue(e){return u(this,void 0,void 0,(function*(){return(yield this.axios.delete(`/api/UUPropertyValue/${e}`)).data}))}getStatements(e){return u(this,void 0,void 0,(function*(){return(yield this.axios.get("/api/UUStatements",{params:e})).data}))}createStatement(e){return u(this,void 0,void 0,(function*(){return(yield this.axios.post("/api/UUStatements",e)).data}))}softDeleteStatement(e,t,r){return u(this,void 0,void 0,(function*(){return(yield this.axios.delete("/api/UUStatements",{data:{subject:e,predicate:t,object:r}})).data}))}getFiles(e){return u(this,void 0,void 0,(function*(){return(yield this.axios.get("/api/UUFile",{params:e})).data}))}uploadFile(e,t){return u(this,void 0,void 0,(function*(){const r=new FormData;r.append("file",e),t&&Object.entries(t).forEach((([e,t])=>{void 0!==t&&r.append(e,String(t))}));return(yield this.axios.post("/api/UUFile",r,{headers:{"Content-Type":"multipart/form-data"}})).data}))}getFile(e){return u(this,void 0,void 0,(function*(){return(yield this.axios.get(`/api/UUFile/${e}`)).data}))}downloadFile(e){return u(this,void 0,void 0,(function*(){return(yield this.axios.get(`/api/UUFile/${e}/download`,{responseType:"arraybuffer"})).data}))}softDeleteFile(e){return u(this,void 0,void 0,(function*(){return(yield this.axios.delete(`/api/UUFile/${e}`)).data}))}getAddresses(e){return u(this,void 0,void 0,(function*(){return(yield this.axios.get("/api/UUAddress",{params:e})).data}))}createOrUpdateAddress(e){return u(this,void 0,void 0,(function*(){return(yield this.axios.post("/api/UUAddress",e)).data}))}createAddress(e){return u(this,void 0,void 0,(function*(){return(yield this.axios.post("/api/UUAddress",e)).data}))}softDeleteAddress(e){return u(this,void 0,void 0,(function*(){return(yield this.axios.delete(`/api/UUAddress/${e}`)).data}))}searchAggregates(e){return u(this,void 0,void 0,(function*(){return(yield this.axios.post("/api/Aggregate/search",e)).data}))}createAggregates(e){return u(this,void 0,void 0,(function*(){return(yield this.axios.post("/api/Aggregate",e)).data}))}importAggregates(e){return u(this,void 0,void 0,(function*(){const t=yield this.axios.post("/api/Aggregate/Import",e);return{data:void 0,status:t.status,statusText:t.statusText,headers:t.headers}}))}uploadFileByReference(e){return u(this,void 0,void 0,(function*(){if(!this.registryClient)throw new Error("Registry client not available for UUID operations");try{const t=(yield this.registryClient.createUUID()).uuid,r={fileReference:e.fileReference,fileName:e.fileName,label:e.label,contentType:e.contentType,size:e.size},i=yield this.createOrUpdateObject(Object.assign(Object.assign({},r),{uuid:t}));return yield this.createStatement({subject:e.uuidToAttach,predicate:exports.Predicate.HAS_FILE,object:t}),{data:i,status:200,statusText:"OK"}}catch(e){return{data:null,status:e.status||500,statusText:e.message||"Error uploading file by reference"}}}))}uploadFileDirect(e){return u(this,void 0,void 0,(function*(){if(!this.registryClient)throw new Error("Registry client not available for UUID operations");try{const t=(yield this.registryClient.createUUID()).uuid,r=yield this.uploadFile(e.file,{uuid:t,label:e.label});return yield this.createStatement({subject:e.uuidToAttach,predicate:exports.Predicate.HAS_FILE,object:t}),{data:r,status:200,statusText:"OK"}}catch(e){return{data:null,status:e.status||500,statusText:e.message||"Error uploading file binary"}}}))}addPropertyToObject(e,t){return u(this,void 0,void 0,(function*(){if(!this.registryClient)throw new Error("Registry client not available");const i=r.z.string().uuid().parse(e);let s;if(t.uuid)s=t;else{const{uuid:e}=yield this.registryClient.createUUID();s=Object.assign(Object.assign({},t),{uuid:e})}const o=yield this.createProperty(s);return yield this.createStatement({subject:i,predicate:exports.Predicate.HAS_PROPERTY,object:o.uuid}),yield this.createStatement({subject:o.uuid,predicate:exports.Predicate.IS_PROPERTY_OF,object:i}),{data:o,status:200,statusText:"OK"}}))}getPropertiesForObject(e,t){return u(this,void 0,void 0,(function*(){const r=yield this.getStatements(Object.assign({subject:e,predicate:exports.Predicate.HAS_PROPERTY},t));if(!r.length)return{data:[],status:200,statusText:"OK"};const i=[];for(const e of r)try{const r=yield this.getProperties(Object.assign({uuid:e.object},t));r[0]&&i.push(r[0])}catch(e){}return{data:i,status:200,statusText:"OK"}}))}setValueForProperty(e,t){return u(this,void 0,void 0,(function*(){if(!this.registryClient)throw new Error("Registry client not available");const i=r.z.string().uuid().parse(e);let s;if(t.uuid)s=t;else{const{uuid:e}=yield this.registryClient.createUUID();s=Object.assign(Object.assign({},t),{uuid:e})}const o=yield this.createPropertyValue(s);return yield this.createStatement({subject:i,predicate:exports.Predicate.HAS_VALUE,object:o.uuid}),yield this.createStatement({subject:o.uuid,predicate:exports.Predicate.IS_VALUE_OF,object:i}),{data:o,status:200,statusText:"OK"}}))}getValuesForProperty(e,t){return u(this,void 0,void 0,(function*(){try{const i=r.z.string().uuid().parse(e),s=yield this.getStatements(Object.assign({subject:i,predicate:exports.Predicate.HAS_VALUE},t));if(!s||0===s.length)return{data:[],status:200,statusText:"OK"};const o=[];for(const e of s)try{const r=(yield this.getPropertyValues(Object.assign({uuid:e.object},t))).find((t=>t.uuid===e.object));r&&o.push(r)}catch(e){}return{data:o,status:200,statusText:"OK"}}catch(e){return{data:[],status:e.status||500,statusText:e.message||"Error getting values for property"}}}))}updateErrorHandling(e){this.errorHandling=e}}class y{constructor(e){this.token=null,this.refreshToken=null,this.user=null,this.listeners=new Set,this.refreshPromise=null,this.isRefreshing=!1,this.STORAGE_KEY="iom-auth-state",a(e),this.config=e,this.loadState(),this.auth=new f(e.auth,e.errorHandling||{},e.certificate),this.registry=new p(e.registry,e.errorHandling||{},this.createServiceAxiosInstance(e.registry.baseUrl)),this.node=new g(e.node,e.errorHandling||{},this.createServiceAxiosInstance(e.node.baseUrl)),this.axiosInstance=this.node.getAxios(),this.ready=this.refreshIfNeededOnStartup()}isAuthenticated(){return!!this.refreshToken}getUser(){return this.user}getToken(){return this.token}isAccessTokenExpired(){if(!this.token)return!0;try{const e=1e3*JSON.parse(atob(this.token.split(".")[1])).exp;return Date.now()>=e-6e4}catch(e){return h("Parse access token",e),!0}}getValidToken(){return u(this,void 0,void 0,(function*(){if(!this.token&&!this.refreshToken)return null;if(!this.isAccessTokenExpired())return this.token;if(this.refreshPromise)try{return yield this.refreshPromise}catch(e){return h("In-flight refresh failed",e),null}if(this.refreshToken)try{return yield this.attemptTokenRefresh()}catch(e){return h("Token refresh failed",e),null}return this.logout(),null}))}refreshIfNeededOnStartup(){return u(this,void 0,void 0,(function*(){if(this.refreshToken&&this.isAccessTokenExpired())if(this.refreshPromise)yield this.refreshPromise;else try{yield this.attemptTokenRefresh()}catch(e){h("Startup refresh failed",null),this.logout()}}))}attemptTokenRefresh(){return u(this,void 0,void 0,(function*(){if(this.refreshPromise)return this.refreshPromise;if(!this.refreshToken)throw this.logout(),new Error("No refresh token");return this.isRefreshing=!0,this.notifyListeners(),this.refreshPromise=(()=>u(this,void 0,void 0,(function*(){var e;try{const e=yield this.auth.refreshToken(this.refreshToken);if(!e.accessToken||!e.refreshToken)throw h("Invalid refresh token response",e),new Error("Invalid refresh token response");return this.token=e.accessToken,this.refreshToken=e.refreshToken,this.saveState(),e.accessToken}catch(t){if(403===(null===(e=t.response)||void 0===e?void 0:e.status))throw h("Refresh token expired",null),this.logout(),new Error("Refresh token expired");throw h("Refresh failed",t),t}finally{this.isRefreshing=!1,this.refreshPromise=null,this.notifyListeners()}})))(),this.refreshPromise}))}createServiceAxiosInstance(e){const r=t.create({baseURL:e,timeout:3e4});return r.interceptors.request.use((e=>u(this,void 0,void 0,(function*(){const t=yield this.getValidToken();return t&&(e.headers.Authorization=`Bearer ${t}`),e})))),r.interceptors.response.use((e=>e),(e=>u(this,void 0,void 0,(function*(){var t,i,s;const o=e.config;if(console.warn("[SDK] Axios response error",{url:null==o?void 0:o.url,status:null===(t=e.response)||void 0===t?void 0:t.status}),401===(null===(i=e.response)||void 0===i?void 0:i.status)&&!o._retry&&!(null===(s=o.url)||void 0===s?void 0:s.includes("/refreshToken"))){o._retry=!0;try{const e=yield this.attemptTokenRefresh();return o.headers.Authorization=`Bearer ${e}`,r(o)}catch(e){h("Axios 401 refresh failed",e),this.logout()}}return Promise.reject(e)})))),"undefined"==typeof window&&this.config.certificate&&(r.defaults.httpsAgent=new o.Agent({cert:this.config.certificate.cert,key:this.config.certificate.key,rejectUnauthorized:!0})),r}login(){return u(this,void 0,void 0,(function*(){try{const e=yield this.auth.login();return this.token=e.token,this.refreshToken=e.refreshToken,this.user=e.user||null,this.saveState(),l("Login successful"),{success:!0,user:this.user||void 0}}catch(e){return h("Login failed",e),{success:!1}}}))}logout(){l("Logout triggered"),this.token=null,this.refreshToken=null,this.user=null,this.refreshPromise=null,this.isRefreshing=!1,this.saveState()}loadState(){if("undefined"==typeof window)return;const e=localStorage.getItem(this.STORAGE_KEY);if(e)try{const{token:t,refreshToken:r,user:i}=JSON.parse(e);this.token=t,this.refreshToken=r,this.user=i}catch(e){localStorage.removeItem(this.STORAGE_KEY)}}saveState(){"undefined"!=typeof window&&(this.refreshToken?localStorage.setItem(this.STORAGE_KEY,JSON.stringify({token:this.token,refreshToken:this.refreshToken,user:this.user})):localStorage.removeItem(this.STORAGE_KEY),this.notifyListeners())}notifyListeners(){const e={isAuthenticated:this.isAuthenticated(),user:this.user,isRefreshing:this.isRefreshing};this.listeners.forEach((t=>t(e)))}onAuthStateChange(e){return this.listeners.add(e),e({isAuthenticated:this.isAuthenticated(),user:this.user,isRefreshing:this.isRefreshing}),()=>this.listeners.delete(e)}getAxios(){return this.axiosInstance}}function v(e){return new y(e)}const U=v;exports.AuthServiceClient=f,exports.Client=y,exports.NodeServiceClient=g,exports.RegistryServiceClient=p,exports.configureLogger=e=>{var t,r,i;e&&(d={enabled:null!==(t=e.enabled)&&void 0!==t?t:d.enabled,logLevel:"info"===e.logLevel?"info":"error",logToConsole:null!==(r=e.logToConsole)&&void 0!==r?r:d.logToConsole,logCallback:null!==(i=e.logCallback)&&void 0!==i?i:d.logCallback})},exports.createClient=U,exports.createDefaultErrorHandling=function(){return{debug:!1,autoRetryAuth:!0,autoRetryNetwork:{maxRetries:3,delay:1e3,backoff:"exponential"}}},exports.createDefaultServiceConfig=function(e){return{baseUrl:e,timeout:3e4,retries:3,headers:{}}},exports.initClient=v,exports.validateSDKConfig=a,exports.validateServiceConfig=n;
//# sourceMappingURL=index.js.map
