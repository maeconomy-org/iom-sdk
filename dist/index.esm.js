import*as e from"https";import t from"axios";import{z as r}from"zod";var i;function s(e,t){if(!e.baseUrl)throw new Error(`${t} service baseUrl is required`);try{new URL(e.baseUrl)}catch(e){throw new Error(`${t} service baseUrl must be a valid URL`)}if(void 0!==e.timeout&&(e.timeout<0||e.timeout>3e5))throw new Error(`${t} service timeout must be between 0 and 300000ms`);if(void 0!==e.retries&&(e.retries<0||e.retries>10))throw new Error(`${t} service retries must be between 0 and 10`)}function o(e){var t;if(!e.auth)throw new Error("Auth service configuration is required");if(!e.registry)throw new Error("Registry service configuration is required");if(!e.node)throw new Error("Node service configuration is required");if(e.certificate&&(!e.certificate.cert||!e.certificate.key))throw new Error("Certificate must include both cert and key when provided");if(s(e.auth,"auth"),s(e.registry,"registry"),s(e.node,"node"),e.tokenStorage&&!["localStorage","sessionStorage","memory"].includes(e.tokenStorage))throw new Error("tokenStorage must be one of: localStorage, sessionStorage, memory");if(null===(t=e.errorHandling)||void 0===t?void 0:t.autoRetryNetwork){const{maxRetries:t,delay:r,backoff:i}=e.errorHandling.autoRetryNetwork;if(t<0||t>10)throw new Error("autoRetryNetwork.maxRetries must be between 0 and 10");if(void 0!==r&&(r<0||r>6e4))throw new Error("autoRetryNetwork.delay must be between 0 and 60000ms");if(i&&!["linear","exponential"].includes(i))throw new Error("autoRetryNetwork.backoff must be either linear or exponential")}}function n(e){return{baseUrl:e,timeout:3e4,retries:3,headers:{}}}function a(){return{debug:!1,autoRetryAuth:!0,autoRetryNetwork:{maxRetries:3,delay:1e3,backoff:"exponential"}}}function u(e,t,r,i){return new(r||(r=Promise))((function(s,o){function n(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(n,a)}u((i=i.apply(e,t||[])).next())}))}!function(e){e.IS_PARENT_OF="IS_PARENT_OF",e.IS_CHILD_OF="IS_CHILD_OF",e.IS_INPUT_OF="IS_INPUT_OF",e.IS_OUTPUT_OF="IS_OUTPUT_OF",e.IS_SOURCE_TEMPLATE_OF="IS_SOURCE_TEMPLATE_OF",e.IS_TEMPLATE_INSTANCE_OF="IS_TEMPLATE_INSTANCE_OF",e.IS_PROPERTY_OF="IS_PROPERTY_OF",e.HAS_PROPERTY="HAS_PROPERTY",e.IS_VALUE_OF="IS_VALUE_OF",e.HAS_VALUE="HAS_VALUE",e.IS_FILE_OF="IS_FILE_OF",e.HAS_FILE="HAS_FILE",e.HAS_ADDRESS="HAS_ADDRESS",e.IS_ADDRESS_OF="IS_ADDRESS_OF"}(i||(i={})),"function"==typeof SuppressedError&&SuppressedError;let l={enabled:!1,logLevel:"error",logToConsole:!0,logCallback:null};const d=e=>{var t,r,i;e&&(l={enabled:null!==(t=e.enabled)&&void 0!==t?t:l.enabled,logLevel:"info"===e.logLevel?"info":"error",logToConsole:null!==(r=e.logToConsole)&&void 0!==r?r:l.logToConsole,logCallback:null!==(i=e.logCallback)&&void 0!==i?i:l.logCallback})},c=(e,t)=>{l.enabled&&((e,t,r)=>{if(!l.enabled)return;l.logLevel;const i=`[IoM Client] ${t}`;l.logToConsole&&console.error(i,r||""),l.logCallback&&l.logCallback(i,r)})(0,`Error in ${e}`,t)};class h{constructor(r,i,s){const o={baseURL:r.baseUrl,timeout:r.timeout||3e4};s&&(o.httpsAgent=new e.Agent({cert:s.cert,key:s.key,rejectUnauthorized:!0})),this.axiosInstance=t.create(o);const n={baseURL:r.refreshBaseUrl||r.baseUrl,timeout:r.timeout||3e4};this.refreshAxiosInstance=t.create(n)}login(){return u(this,void 0,void 0,(function*(){const e=yield this.axiosInstance.get("/api/auth/login"),{accessToken:t,refreshToken:r,user:i}=e.data,s=t.trim(),o=function(e){let t=3600;try{const r=e.split(".");if(3===r.length){const e=r[1].replace(/-/g,"+").replace(/_/g,"/"),i=e+"=".repeat((4-e.length%4)%4),s="undefined"!=typeof atob?atob(i):Buffer.from(i,"base64").toString("utf-8"),o=JSON.parse(s);o.exp&&o.iat&&(t=o.exp-o.iat)}}catch(e){c("Failed to decode JWT payload for expiry calculation",e)}return t}(s);return{token:s,expiresIn:o,tokenType:"Bearer",refreshToken:r,user:i}}))}refreshToken(e){return u(this,void 0,void 0,(function*(){const t={refreshToken:e};return(yield this.refreshAxiosInstance.post("/api/auth/refreshToken",t)).data}))}}class f{constructor(e,t,r){this.axios=r}getOwnedUUIDs(){return u(this,void 0,void 0,(function*(){return(yield this.axios.get("/api/UUID/own")).data}))}createUUID(){return u(this,void 0,void 0,(function*(){return(yield this.axios.post("/api/UUID")).data}))}getUUIDRecord(e){return u(this,void 0,void 0,(function*(){return(yield this.axios.get(`/api/UUID/${e}`)).data}))}updateUUIDRecordMeta(e,t){return u(this,void 0,void 0,(function*(){return(yield this.axios.put("/api/UUID/UUIDRecordMeta",t)).data}))}authorizeUUIDRecord(e){return u(this,void 0,void 0,(function*(){return(yield this.axios.post("/api/UUID/authorize",{userUUID:e.userUUID,resourceId:e.resourceId})).data}))}}class g{constructor(e,t,r,i){this.errorHandling=t,this.axios=r,this.registryClient=i}getAxios(){return this.axios}request(e){return u(this,void 0,void 0,(function*(){const t=yield this.axios.request(e);return{data:t.data,status:t.status,statusText:t.statusText,headers:t.headers}}))}getObjects(e){return u(this,void 0,void 0,(function*(){return(yield this.axios.get("/api/UUObject",{params:e})).data}))}createOrUpdateObject(e){return u(this,void 0,void 0,(function*(){return(yield this.axios.post("/api/UUObject",e)).data}))}softDeleteObject(e){return u(this,void 0,void 0,(function*(){return(yield this.axios.delete(`/api/UUObject/${e}`)).data}))}getProperties(e){return u(this,void 0,void 0,(function*(){return(yield this.axios.get("/api/UUProperty",{params:e})).data}))}createOrUpdateProperty(e){return u(this,void 0,void 0,(function*(){return(yield this.axios.post("/api/UUProperty",e)).data}))}createProperty(e){return u(this,void 0,void 0,(function*(){return(yield this.axios.post("/api/UUProperty",e)).data}))}softDeleteProperty(e){return u(this,void 0,void 0,(function*(){return(yield this.axios.delete(`/api/UUProperty/${e}`)).data}))}getPropertyValues(e){return u(this,void 0,void 0,(function*(){return(yield this.axios.get("/api/UUPropertyValue",{params:e})).data}))}createOrUpdatePropertyValue(e){return u(this,void 0,void 0,(function*(){return(yield this.axios.post("/api/UUPropertyValue",e)).data}))}createPropertyValue(e){return u(this,void 0,void 0,(function*(){return(yield this.axios.post("/api/UUPropertyValue",e)).data}))}softDeletePropertyValue(e){return u(this,void 0,void 0,(function*(){return(yield this.axios.delete(`/api/UUPropertyValue/${e}`)).data}))}getStatements(e){return u(this,void 0,void 0,(function*(){return(yield this.axios.get("/api/UUStatements",{params:e})).data}))}createStatement(e){return u(this,void 0,void 0,(function*(){return(yield this.axios.post("/api/UUStatements",e)).data}))}softDeleteStatement(e,t,r){return u(this,void 0,void 0,(function*(){return(yield this.axios.delete("/api/UUStatements",{data:{subject:e,predicate:t,object:r}})).data}))}getFiles(e){return u(this,void 0,void 0,(function*(){return(yield this.axios.get("/api/UUFile",{params:e})).data}))}uploadFile(e,t){return u(this,void 0,void 0,(function*(){const r=new FormData;r.append("file",e),t&&Object.entries(t).forEach((([e,t])=>{void 0!==t&&r.append(e,String(t))}));return(yield this.axios.post("/api/UUFile",r,{headers:{"Content-Type":"multipart/form-data"}})).data}))}getFile(e){return u(this,void 0,void 0,(function*(){return(yield this.axios.get(`/api/UUFile/${e}`)).data}))}downloadFile(e){return u(this,void 0,void 0,(function*(){return(yield this.axios.get(`/api/UUFile/${e}/download`,{responseType:"arraybuffer"})).data}))}softDeleteFile(e){return u(this,void 0,void 0,(function*(){return(yield this.axios.delete(`/api/UUFile/${e}`)).data}))}getAddresses(e){return u(this,void 0,void 0,(function*(){return(yield this.axios.get("/api/UUAddress",{params:e})).data}))}createOrUpdateAddress(e){return u(this,void 0,void 0,(function*(){return(yield this.axios.post("/api/UUAddress",e)).data}))}createAddress(e){return u(this,void 0,void 0,(function*(){return(yield this.axios.post("/api/UUAddress",e)).data}))}softDeleteAddress(e){return u(this,void 0,void 0,(function*(){return(yield this.axios.delete(`/api/UUAddress/${e}`)).data}))}searchAggregates(e){return u(this,void 0,void 0,(function*(){return(yield this.axios.post("/api/Aggregate/search",e)).data}))}createAggregates(e){return u(this,void 0,void 0,(function*(){return(yield this.axios.post("/api/Aggregate",e)).data}))}importAggregates(e){return u(this,void 0,void 0,(function*(){const t=yield this.axios.post("/api/Aggregate/Import",e);return{data:void 0,status:t.status,statusText:t.statusText,headers:t.headers}}))}uploadFileByReference(e){return u(this,void 0,void 0,(function*(){if(!this.registryClient)throw new Error("Registry client not available for UUID operations");try{const t=(yield this.registryClient.createUUID()).uuid,r={fileReference:e.fileReference,fileName:e.fileName,label:e.label,contentType:e.contentType,size:e.size},s=yield this.createOrUpdateObject(Object.assign(Object.assign({},r),{uuid:t}));return yield this.createStatement({subject:e.uuidToAttach,predicate:i.HAS_FILE,object:t}),{data:s,status:200,statusText:"OK"}}catch(e){return{data:null,status:e.status||500,statusText:e.message||"Error uploading file by reference"}}}))}uploadFileDirect(e){return u(this,void 0,void 0,(function*(){if(!this.registryClient)throw new Error("Registry client not available for UUID operations");try{const t=(yield this.registryClient.createUUID()).uuid,r=yield this.uploadFile(e.file,{uuid:t,label:e.label});return yield this.createStatement({subject:e.uuidToAttach,predicate:i.HAS_FILE,object:t}),{data:r,status:200,statusText:"OK"}}catch(e){return{data:null,status:e.status||500,statusText:e.message||"Error uploading file binary"}}}))}addPropertyToObject(e,t){return u(this,void 0,void 0,(function*(){if(!this.registryClient)throw new Error("Registry client not available");const s=r.string().uuid().parse(e);let o;if(t.uuid)o=t;else{const{uuid:e}=yield this.registryClient.createUUID();o=Object.assign(Object.assign({},t),{uuid:e})}const n=yield this.createProperty(o);return yield this.createStatement({subject:s,predicate:i.HAS_PROPERTY,object:n.uuid}),yield this.createStatement({subject:n.uuid,predicate:i.IS_PROPERTY_OF,object:s}),{data:n,status:200,statusText:"OK"}}))}getPropertiesForObject(e,t){return u(this,void 0,void 0,(function*(){const r=yield this.getStatements(Object.assign({subject:e,predicate:i.HAS_PROPERTY},t));if(!r.length)return{data:[],status:200,statusText:"OK"};const s=[];for(const e of r)try{const r=yield this.getProperties(Object.assign({uuid:e.object},t));r[0]&&s.push(r[0])}catch(e){}return{data:s,status:200,statusText:"OK"}}))}setValueForProperty(e,t){return u(this,void 0,void 0,(function*(){if(!this.registryClient)throw new Error("Registry client not available");const s=r.string().uuid().parse(e);let o;if(t.uuid)o=t;else{const{uuid:e}=yield this.registryClient.createUUID();o=Object.assign(Object.assign({},t),{uuid:e})}const n=yield this.createPropertyValue(o);return yield this.createStatement({subject:s,predicate:i.HAS_VALUE,object:n.uuid}),yield this.createStatement({subject:n.uuid,predicate:i.IS_VALUE_OF,object:s}),{data:n,status:200,statusText:"OK"}}))}getValuesForProperty(e,t){return u(this,void 0,void 0,(function*(){try{const s=r.string().uuid().parse(e),o=yield this.getStatements(Object.assign({subject:s,predicate:i.HAS_VALUE},t));if(!o||0===o.length)return{data:[],status:200,statusText:"OK"};const n=[];for(const e of o)try{const r=(yield this.getPropertyValues(Object.assign({uuid:e.object},t))).find((t=>t.uuid===e.object));r&&n.push(r)}catch(e){}return{data:n,status:200,statusText:"OK"}}catch(e){return{data:[],status:e.status||500,statusText:e.message||"Error getting values for property"}}}))}updateErrorHandling(e){this.errorHandling=e}}const p=e=>e?`${e.slice(0,10)}...${e.slice(-6)}`:"null";class y{constructor(e){this.token=null,this.refreshToken=null,this.user=null,this.listeners=new Set,this.refreshPromise=null,this.isRefreshing=!1,this.STORAGE_KEY="iom-auth-state",o(e),this.config=e,this.loadState(),this.auth=new h(e.auth,e.errorHandling||{},e.certificate),this.registry=new f(e.registry,e.errorHandling||{},this.createServiceAxiosInstance(e.registry.baseUrl)),this.node=new g(e.node,e.errorHandling||{},this.createServiceAxiosInstance(e.node.baseUrl)),this.axiosInstance=this.node.getAxios(),this.ready=this.refreshIfNeededOnStartup()}isAuthenticated(){return!!this.refreshToken}getUser(){return this.user}getToken(){return this.token}isAccessTokenExpired(){if(!this.token)return!0;try{const e=1e3*JSON.parse(atob(this.token.split(".")[1])).exp,t=Date.now()>=e-6e4;return console.log("[SDK] access-token-check",{expired:t,exp:new Date(e).toISOString(),now:(new Date).toISOString(),token:p(this.token)}),t}catch(e){return console.warn("[SDK] failed to parse access token",e),!0}}getValidToken(){return u(this,void 0,void 0,(function*(){if(!this.token&&!this.refreshToken)return console.log("[SDK] getValidToken - no token or refreshToken"),null;if(!this.isAccessTokenExpired())return console.log("[SDK] getValidToken - token valid",{token:p(this.token)}),this.token;if(this.refreshPromise){console.log("[SDK] getValidToken - awaiting in-flight refresh");try{const e=yield this.refreshPromise;return console.log("[SDK] getValidToken - received refreshed token",{token:p(e)}),e}catch(e){return console.warn("[SDK] getValidToken - in-flight refresh failed",e),null}}if(this.refreshToken){console.log("[SDK] getValidToken - triggering refresh",{oldToken:p(this.token)});try{const e=yield this.attemptTokenRefresh();return console.log("[SDK] getValidToken - refresh completed",{token:p(e)}),e}catch(e){return console.warn("[SDK] getValidToken - refresh failed",e),null}}return this.logout(),null}))}refreshIfNeededOnStartup(){return u(this,void 0,void 0,(function*(){if(this.refreshToken)if(this.isAccessTokenExpired()){if(this.refreshPromise)return console.log("[SDK] Startup refresh awaiting in-flight refresh"),void(yield this.refreshPromise);try{console.log("[SDK] Startup refresh triggered",{oldToken:p(this.token)}),yield this.attemptTokenRefresh()}catch(e){console.warn("[SDK] Startup refresh failed, logging out"),this.logout()}}else console.log("[SDK] Startup refresh skipped - token still valid",{token:p(this.token)})}))}attemptTokenRefresh(){return u(this,void 0,void 0,(function*(){if(this.refreshPromise)return console.log("[SDK] attemptTokenRefresh - single-flight awaiting existing refresh"),this.refreshPromise;if(!this.refreshToken)throw console.warn("[SDK] attemptTokenRefresh - no refresh token, logging out"),this.logout(),new Error("No refresh token");this.isRefreshing=!0,this.notifyListeners();const e=this.token;return this.refreshPromise=(()=>u(this,void 0,void 0,(function*(){var t;try{console.log("[SDK] Refreshing access token...",{oldToken:p(e)});const t=yield this.auth.refreshToken(this.refreshToken);if(!t.accessToken||!t.refreshToken)throw new Error("Invalid refresh token response");return this.token=t.accessToken,this.refreshToken=t.refreshToken,this.saveState(),console.log("[SDK] Refresh successful",{oldToken:p(e),newToken:p(t.accessToken)}),t.accessToken}catch(e){if(403===(null===(t=e.response)||void 0===t?void 0:t.status))throw console.warn("[SDK] Refresh token expired, logging out"),this.logout(),new Error("Refresh token expired");throw console.error("[SDK] Refresh failed",e),e}finally{this.isRefreshing=!1,this.refreshPromise=null,this.notifyListeners(),console.log("[SDK] Refresh finished")}})))(),this.refreshPromise}))}createServiceAxiosInstance(r){const i=t.create({baseURL:r,timeout:3e4});return i.interceptors.request.use((e=>u(this,void 0,void 0,(function*(){const t=yield this.getValidToken();return t&&(e.headers.Authorization=`Bearer ${t}`),console.log("[SDK] Axios request",{url:e.url,token:p(t)}),e})))),i.interceptors.response.use((e=>e),(e=>u(this,void 0,void 0,(function*(){var t,r,s;const o=e.config;if(console.warn("[SDK] Axios response error",{url:null==o?void 0:o.url,status:null===(t=e.response)||void 0===t?void 0:t.status}),401===(null===(r=e.response)||void 0===r?void 0:r.status)&&!o._retry&&!(null===(s=o.url)||void 0===s?void 0:s.includes("/refreshToken"))){o._retry=!0,console.log("[SDK] Axios 401 - triggering refresh",{url:o.url});try{const e=yield this.attemptTokenRefresh();return o.headers.Authorization=`Bearer ${e}`,console.log("[SDK] Axios retrying request with new token",{url:o.url,token:p(e)}),i(o)}catch(e){console.warn("[SDK] Axios 401 refresh failed, logging out",e),this.logout()}}return Promise.reject(e)})))),"undefined"==typeof window&&this.config.certificate&&(i.defaults.httpsAgent=new e.Agent({cert:this.config.certificate.cert,key:this.config.certificate.key,rejectUnauthorized:!0})),i}login(){return u(this,void 0,void 0,(function*(){try{console.log("[SDK] login triggered");const e=yield this.auth.login();return this.token=e.token,this.refreshToken=e.refreshToken,this.user=e.user||null,this.saveState(),console.log("[SDK] login successful",{token:p(this.token),refreshToken:p(this.refreshToken)}),{success:!0,user:this.user||void 0}}catch(e){return console.warn("[SDK] login failed",e),this.logout(),{success:!1}}}))}logout(){console.log("[SDK] logout triggered"),this.token=null,this.refreshToken=null,this.user=null,this.refreshPromise=null,this.isRefreshing=!1,this.saveState()}loadState(){if("undefined"==typeof window)return;const e=localStorage.getItem(this.STORAGE_KEY);if(e)try{const{token:t,refreshToken:r,user:i}=JSON.parse(e);this.token=t,this.refreshToken=r,this.user=i}catch(e){localStorage.removeItem(this.STORAGE_KEY)}}saveState(){"undefined"!=typeof window&&(this.refreshToken?localStorage.setItem(this.STORAGE_KEY,JSON.stringify({token:this.token,refreshToken:this.refreshToken,user:this.user})):localStorage.removeItem(this.STORAGE_KEY),this.notifyListeners())}notifyListeners(){const e={isAuthenticated:this.isAuthenticated(),user:this.user,isRefreshing:this.isRefreshing};this.listeners.forEach((t=>t(e)))}onAuthStateChange(e){return this.listeners.add(e),e({isAuthenticated:this.isAuthenticated(),user:this.user,isRefreshing:this.isRefreshing}),()=>this.listeners.delete(e)}getAxios(){return this.axiosInstance}}function v(e){return new y(e)}const S=v;export{h as AuthServiceClient,y as Client,g as NodeServiceClient,i as Predicate,f as RegistryServiceClient,d as configureLogger,S as createClient,a as createDefaultErrorHandling,n as createDefaultServiceConfig,v as initClient,o as validateSDKConfig,s as validateServiceConfig};
//# sourceMappingURL=index.esm.js.map
